#include "bitmap_font.h"

#include <string.h>

static const unsigned char FONT_DATA[96][FONT_CHAR_HEIGHT] = {
    ['A' - 32] = { 0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11 },
    ['B' - 32] = { 0x1E, 0x11, 0x1E, 0x11, 0x11, 0x11, 0x1E },
    ['C' - 32] = { 0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E },
    ['D' - 32] = { 0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C },
    ['E' - 32] = { 0x1F, 0x10, 0x1E, 0x10, 0x10, 0x10, 0x1F },
    ['F' - 32] = { 0x1F, 0x10, 0x1E, 0x10, 0x10, 0x10, 0x10 },
    ['G' - 32] = { 0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0F },
    ['H' - 32] = { 0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11 },
    ['I' - 32] = { 0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x1F },
    ['J' - 32] = { 0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0C },
    ['K' - 32] = { 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11 },
    ['L' - 32] = { 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F },
    ['M' - 32] = { 0x11, 0x1B, 0x15, 0x11, 0x11, 0x11, 0x11 },
    ['N' - 32] = { 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x11 },
    ['O' - 32] = { 0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E },
    ['P' - 32] = { 0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10 },
    ['Q' - 32] = { 0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D },
    ['R' - 32] = { 0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11 },
    ['S' - 32] = { 0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E },
    ['T' - 32] = { 0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 },
    ['U' - 32] = { 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E },
    ['V' - 32] = { 0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04 },
    ['W' - 32] = { 0x11, 0x11, 0x11, 0x11, 0x15, 0x1B, 0x11 },
    ['X' - 32] = { 0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11 },
    ['Y' - 32] = { 0x11, 0x11, 0x11, 0x0A, 0x04, 0x04, 0x04 },
    ['Z' - 32] = { 0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F },
    ['0' - 32] = { 0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E },
    ['1' - 32] = { 0x04, 0x0C, 0x14, 0x04, 0x04, 0x04, 0x1F },
    ['2' - 32] = { 0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F },
    ['3' - 32] = { 0x1F, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0E },
    ['4' - 32] = { 0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02 },
    ['5' - 32] = { 0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E },
    ['6' - 32] = { 0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E },
    ['7' - 32] = { 0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08 },
    ['8' - 32] = { 0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E },
    ['9' - 32] = { 0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C },
    [' ' - 32] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    ['-' - 32] = { 0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00 },
    ['!' - 32] = { 0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x04 },
    ['\'' - 32] = { 0x0C, 0x0C, 0x04, 0x08, 0x00, 0x00, 0x00 },
    ['?' - 32] = { 0x0E, 0x11, 0x01, 0x06, 0x04, 0x00, 0x04 },
    ['.' - 32] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04 },
    [',' - 32] = { 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x08 },
    [':' - 32] = { 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00 },
    ['/' - 32] = { 0x01, 0x02, 0x04, 0x08, 0x10, 0x00, 0x00 },
    ['(' - 32] = { 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02 },
    [')' - 32] = { 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08 },
    ['>' - 32] = { 0x10, 0x08, 0x04, 0x02, 0x04, 0x08, 0x10 },
    ['<' - 32] = { 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02 }
};

bool bitmap_font_init(BitmapFont *font) {
    if (!font) {
        return false;
    }
    font->glyphWidth = FONT_CHAR_WIDTH;
    font->glyphHeight = FONT_CHAR_HEIGHT;
    font->glyphSpacing = 1;
    return true;
}

void bitmap_font_shutdown(BitmapFont *font) {
    (void)font;
}

static const unsigned char *glyph_for_char(char c) {
    unsigned char upper = (unsigned char)c;
    if (upper >= 'a' && upper <= 'z') {
        upper = (unsigned char)(upper - 32);
    }
    if (upper < 32 || upper > 127) {
        return NULL;
    }
    return FONT_DATA[upper - 32];
}

void bitmap_font_draw_text(SDL_Renderer *renderer, const BitmapFont *font, int x, int y, const char *text, SDL_Color color) {
    if (!renderer || !font || !text) {
        return;
    }

    SDL_SetRenderDrawColor(renderer, color.r, color.g, color.b, color.a);

    int cursorX = x;
    int cursorY = y;
    int lineHeight = font->glyphHeight * BITMAP_FONT_SCALE + BITMAP_FONT_SCALE;

    for (size_t i = 0; text[i] != '\0'; ++i) {
        char c = text[i];
        if (c == '\n') {
            cursorX = x;
            cursorY += lineHeight;
            continue;
        }

        const unsigned char *glyph = glyph_for_char(c);
        if (!glyph) {
            cursorX += (font->glyphWidth + font->glyphSpacing) * BITMAP_FONT_SCALE;
            continue;
        }

        for (int row = 0; row < font->glyphHeight; ++row) {
            unsigned char rowBits = glyph[row];
            for (int col = 0; col < font->glyphWidth; ++col) {
                unsigned char mask = (unsigned char)(1 << (font->glyphWidth - 1 - col));
                if (rowBits & mask) {
                    SDL_Rect pixel = {
                        cursorX + col * BITMAP_FONT_SCALE,
                        cursorY + row * BITMAP_FONT_SCALE,
                        BITMAP_FONT_SCALE,
                        BITMAP_FONT_SCALE
                    };
                    SDL_RenderFillRect(renderer, &pixel);
                }
            }
        }
        cursorX += (font->glyphWidth + font->glyphSpacing) * BITMAP_FONT_SCALE;
    }
}

int bitmap_font_measure_text(const BitmapFont *font, const char *text) {
    if (!font || !text) {
        return 0;
    }

    int maxWidth = 0;
    int currentWidth = 0;
    int advance = (font->glyphWidth + font->glyphSpacing) * BITMAP_FONT_SCALE;

    for (size_t i = 0; text[i] != '\0'; ++i) {
        if (text[i] == '\n') {
            if (currentWidth > maxWidth) {
                maxWidth = currentWidth;
            }
            currentWidth = 0;
            continue;
        }
        currentWidth += advance;
    }
    if (currentWidth > maxWidth) {
        maxWidth = currentWidth;
    }
    return maxWidth;
}
